<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库表创建指南 - AI旅行规划器</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        .step { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 8px; }
        code { background: #eee; padding: 2px 6px; border-radius: 4px; }
        .important { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; }
        .sql-code { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>数据库表创建指南</h1>
    
    <div class="important">
        <h3>⚠️ 问题诊断</h3>
        <p>检测到错误：<code>42P01 - 数据库表不存在</code></p>
        <p>当前应用无法连接到 <code>travel_demands</code> 表，因为该表尚未在Supabase中创建。</p>
    </div>
    
    <div class="step">
        <h2>解决方案1：在Supabase中创建数据库表</h2>
        
        <h3>步骤1：登录Supabase</h3>
        <ol>
            <li>访问 <a href="https://supabase.com" target="_blank">Supabase官网</a></li>
            <li>登录您的账户</li>
            <li>选择您的项目：<code>ipljkdsphqoidcsjpzve</code></li>
        </ol>
        
        <h3>步骤2：执行SQL语句</h3>
        <ol>
            <li>在Supabase仪表板中，点击左侧菜单的 "SQL Editor"</li>
            <li>点击 "New Query" 创建新查询</li>
            <li>将以下SQL代码复制粘贴到编辑器中：</li>
        </ol>
        
        <div class="sql-code">
            <pre><code>-- 创建旅行需求表
CREATE TABLE IF NOT EXISTS travel_demands (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    
    -- 旅行需求信息
    destination TEXT NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    budget INTEGER,
    travelers INTEGER,
    preferences TEXT,
    special_requirements TEXT,
    
    -- 状态管理
    status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'submitted', 'processing', 'completed', 'cancelled')),
    
    -- 时间戳
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    
    -- 约束条件
    CONSTRAINT valid_budget CHECK (budget IS NULL OR budget > 0),
    CONSTRAINT valid_travelers CHECK (travelers IS NULL OR travelers > 0),
    CONSTRAINT valid_date_range CHECK (end_date >= start_date)
);

-- 创建索引以提高查询性能
CREATE INDEX IF NOT EXISTS idx_travel_demands_user_id ON travel_demands(user_id);
CREATE INDEX IF NOT EXISTS idx_travel_demands_status ON travel_demands(status);
CREATE INDEX IF NOT EXISTS idx_travel_demands_created_at ON travel_demands(created_at);

-- 创建更新时间触发器
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE OR REPLACE TRIGGER update_travel_demands_updated_at 
    BEFORE UPDATE ON travel_demands 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();

-- 启用行级安全策略
ALTER TABLE travel_demands ENABLE ROW LEVEL SECURITY;

-- 创建安全策略：用户只能访问自己的数据
CREATE POLICY "用户只能访问自己的旅行需求" ON travel_demands
    FOR ALL USING (auth.uid() = user_id);

-- 允许匿名用户插入数据（用于注册前的草稿保存）
CREATE POLICY "允许匿名用户插入草稿" ON travel_demands
    FOR INSERT WITH CHECK (true);</code></pre>
        </div>
        
        <ol start="4">
            <li>点击 "Run" 按钮执行SQL语句</li>
            <li>等待执行完成，确认没有错误</li>
        </ol>
        
        <h3>步骤3：验证表创建</h3>
        <ol>
            <li>点击左侧菜单的 "Table Editor"</li>
            <li>检查是否能看到 <code>travel_demands</code> 表</li>
            <li>如果看到表，说明创建成功</li>
        </ol>
    </div>
    
    <div class="step">
        <h2>解决方案2：使用本地存储（临时方案）</h2>
        <p>如果您暂时无法创建数据库表，应用会自动使用localStorage作为备用存储方案：</p>
        
        <div class="important">
            <h4>本地存储特性</h4>
            <ul>
                <li>✅ 数据保存在浏览器本地</li>
                <li>✅ 无需数据库配置</li>
                <li>❌ 数据仅在当前浏览器有效</li>
                <li>❌ 清除浏览器数据会丢失保存的内容</li>
                <li>❌ 不同设备间无法同步数据</li>
            </ul>
        </div>
        
        <p>当检测到数据库表不存在时，应用会自动切换到本地存储模式，并显示提示信息。</p>
    </div>
    
    <div class="step">
        <h2>验证解决方案</h2>
        <ol>
            <li>刷新旅行需求页面</li>
            <li>填写旅行需求信息</li>
            <li>点击"保存草稿"按钮</li>
            <li>检查是否显示成功消息</li>
            <li>在浏览器开发者工具中检查Console是否有错误</li>
        </ol>
    </div>
    
    <div class="important">
        <h3>故障排除</h3>
        <ul>
            <li><strong>SQL执行错误</strong>：检查SQL语法，确保没有复制多余的空格或字符</li>
            <li><strong>权限错误</strong>：确保您的Supabase账户有创建表的权限</li>
            <li><strong>网络问题</strong>：检查网络连接，确保能正常访问Supabase</li>
            <li><strong>控制台错误</strong>：打开浏览器开发者工具，查看Console标签页的错误信息</li>
        </ul>
    </div>
    
    <h2>下一步</h2>
    <p>创建数据库表后，应用将能够：</p>
    <ul>
        <li>✅ 保存旅行需求草稿</li>
        <li>✅ 提交旅行需求</li>
        <li>✅ 多设备同步数据</li>
        <li>✅ 持久化存储数据</li>
    </ul>
</body>
</html>