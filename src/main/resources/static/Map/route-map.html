<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¯çº¿è§„åˆ’åœ°å›¾ - AIæ—…è¡Œè§„åˆ’å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 400px;
            background: white;
            border-right: 1px solid #e1e5e9;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            padding: 20px;
            background: #2c3e50;
            color: white;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .input-section {
            padding: 20px;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .route-info {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .info-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }
        
        .info-section h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .info-label {
            color: #7f8c8d;
            font-weight: 500;
        }
        
        .info-value {
            color: #2c3e50;
            font-weight: 600;
        }
        
        .path-steps {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 10px;
        }
        
        .path-step {
            padding: 5px 0;
            border-bottom: 1px solid #f1f2f6;
            font-size: 0.85em;
            color: #5a6c7d;
        }
        
        .path-step:last-child {
            border-bottom: none;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            text-align: center;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .success-message {
            background: #27ae60;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="header">
                <h1>ğŸš¶ æ­¥è¡Œè·¯çº¿è§„åˆ’</h1>
                <p>AIæ—…è¡Œè§„åˆ’å™¨ - æ™ºèƒ½è·¯çº¿å¯¼èˆª</p>
            </div>
            
            <div class="input-section">
                <div class="input-group">
                    <label for="origin">ğŸ“ èµ·ç‚¹ä½ç½®</label>
                    <input type="text" id="origin" placeholder="è¾“å…¥èµ·ç‚¹åœ°å€æˆ–ç»çº¬åº¦ (å¦‚: åŒ—äº¬å¸‚æµ·æ·€åŒºä¸­å…³æ‘å¤§è¡—)">
                </div>
                
                <div class="input-group">
                    <label for="destination">ğŸ ç»ˆç‚¹ä½ç½®</label>
                    <input type="text" id="destination" placeholder="è¾“å…¥ç»ˆç‚¹åœ°å€æˆ–ç»çº¬åº¦ (å¦‚: åŒ—äº¬å¸‚æœé˜³åŒºä¸‰é‡Œå±¯)">
                </div>
                
                <div class="buttons">
                    <button class="btn btn-primary" id="planRoute">ğŸš€ è§„åˆ’è·¯çº¿</button>
                    <button class="btn btn-secondary" id="clearRoute">ğŸ—‘ï¸ æ¸…é™¤è·¯çº¿</button>
                </div>
                
                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
            </div>
            
            <div class="route-info" id="routeInfo">
                <div class="info-section">
                    <h3>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
                    <p>è¾“å…¥èµ·ç‚¹å’Œç»ˆç‚¹åœ°å€æˆ–ç»çº¬åº¦åæ ‡ï¼Œç‚¹å‡»"è§„åˆ’è·¯çº¿"æŒ‰é’®å³å¯ç”Ÿæˆæ­¥è¡Œè·¯çº¿ã€‚</p>
                    <p>æ”¯æŒæ ¼å¼ï¼š</p>
                    <ul>
                        <li>åœ°å€ï¼š"åŒ—äº¬å¸‚æµ·æ·€åŒºä¸­å…³æ‘å¤§è¡—"</li>
                        <li>åæ ‡ï¼š"116.397428,39.90923"</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨è§„åˆ’è·¯çº¿ä¸­...</p>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // å…¨å±€å˜é‡
        let map = null;
        let routeData = null;
        let amapApiKey = null;
        
        // åˆå§‹åŒ–åœ°å›¾å’ŒAPI Key
        async function initMap() {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                showLoading(true);
                
                // 1. è·å–é«˜å¾·åœ°å›¾API Key
                await fetchApiKey();
                
                if (!amapApiKey) {
                    showError('æ— æ³•è·å–é«˜å¾·åœ°å›¾API Keyï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®');
                    return;
                }
                
                // 2. åŠ¨æ€åŠ è½½é«˜å¾·åœ°å›¾JS API
                await loadAmapApi();
                
                // 3. åˆå§‹åŒ–åœ°å›¾ï¼ˆæ·»åŠ å®Œæ•´çš„é”™è¯¯å¤„ç†ï¼‰
                try {
                    // é¦–å…ˆç¡®ä¿åœ°å›¾å®¹å™¨å­˜åœ¨ä¸”å¯è§
                    const mapContainer = document.getElementById('map');
                    if (!mapContainer) {
                        throw new Error('åœ°å›¾å®¹å™¨å…ƒç´ ä¸å­˜åœ¨');
                    }
                    
                    // ç¡®ä¿å®¹å™¨æœ‰æ­£ç¡®çš„å°ºå¯¸
                    mapContainer.style.width = '100%';
                    mapContainer.style.height = '100%';
                    mapContainer.style.minHeight = '400px';
                    
                    // ä½¿ç”¨æœ€ç®€åŒ–çš„é…ç½®åˆå§‹åŒ–åœ°å›¾
                    map = new AMap.Map('map', {
                        zoom: 13,
                        center: [116.397428, 39.90923], // åŒ—äº¬ä¸­å¿ƒ
                        viewMode: '2D' // ä½¿ç”¨2Dæ¨¡å¼é¿å…3Dæ¸²æŸ“é—®é¢˜
                    });
                    
                    console.log('åœ°å›¾åˆå§‹åŒ–æˆåŠŸ');
                } catch (error) {
                    console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                    showError('åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼š' + error.message);
                    return;
                }
                
                // 4. æ·»åŠ åœ°å›¾æ§ä»¶ï¼ˆv2.0ç‰ˆæœ¬å…¼å®¹ï¼‰
                setTimeout(() => {
                    if (map && map.addControl) {
                        map.addControl(new AMap.Scale({
                            position: 'LB'
                        }));
                        map.addControl(new AMap.ToolBar({
                            position: 'RT'
                        }));
                    }
                }, 500);
                
                // 5. ç»‘å®šäº‹ä»¶
                bindEvents();
                
                showSuccess('åœ°å›¾åˆå§‹åŒ–æˆåŠŸï¼');
                
            } catch (error) {
                console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                showError('åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼š' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // è·å–é«˜å¾·åœ°å›¾API Key
        async function fetchApiKey() {
            try {
                const response = await fetch('/api/map-api-key');
                const data = await response.json();
                
                if (data.success) {
                    amapApiKey = data.apiKey;
                    console.log('API Keyè·å–æˆåŠŸ:', amapApiKey);
                } else {
                    throw new Error(data.error || 'API Keyè·å–å¤±è´¥');
                }
            } catch (error) {
                console.error('è·å–API Keyå¤±è´¥:', error);
                throw error;
            }
        }
        
        // åŠ¨æ€åŠ è½½é«˜å¾·åœ°å›¾API
        function loadAmapApi() {
            return new Promise((resolve, reject) => {
                if (window.AMap) {
                    resolve();
                    return;
                }
                
                // ä½¿ç”¨æœ€ç®€å•çš„æ–¹å¼åŠ è½½APIï¼Œé¿å…æ’ä»¶å‚æ•°å¯¼è‡´çš„é—®é¢˜
                const script = document.createElement('script');
                script.src = `https://webapi.amap.com/maps?v=2.0&key=${amapApiKey}`;
                
                script.onload = function() {
                    // ç­‰å¾…åœ°å›¾APIå®Œå…¨åˆå§‹åŒ–
                    setTimeout(() => {
                        // åªåŠ è½½å¿…éœ€çš„æ’ä»¶ï¼Œé¿å…åŒæ—¶åŠ è½½è¿‡å¤šæ’ä»¶
                        AMap.plugin(['AMap.Scale', 'AMap.ToolBar'], function() {
                            // å…¶ä»–æ’ä»¶åœ¨éœ€è¦æ—¶åŠ¨æ€åŠ è½½
                            resolve();
                        });
                    }, 100);
                };
                
                script.onerror = function(error) {
                    console.error('åœ°å›¾APIåŠ è½½å¤±è´¥:', error);
                    reject(error);
                };
                
                document.head.appendChild(script);
            });
        }
        
        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            document.getElementById('planRoute').addEventListener('click', planRoute);
            document.getElementById('clearRoute').addEventListener('click', clearRoute);
            
            // å›è½¦é”®è§¦å‘è·¯çº¿è§„åˆ’
            document.getElementById('origin').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') planRoute();
            });
            
            document.getElementById('destination').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') planRoute();
            });
        }
        
        // è§„åˆ’è·¯çº¿
        async function planRoute() {
            const origin = document.getElementById('origin').value.trim();
            const destination = document.getElementById('destination').value.trim();
            
            if (!origin || !destination) {
                showError('è¯·è¾“å…¥èµ·ç‚¹å’Œç»ˆç‚¹ä½ç½®');
                return;
            }
            
            try {
                showLoading(true);
                
                // è°ƒç”¨åç«¯APIè¿›è¡Œè·¯çº¿è§„åˆ’ï¼ˆæ·»åŠ è¶…æ—¶æ§åˆ¶ï¼‰
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶
                
                const response = await fetch('/api/plan-walking-route', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        origin: origin,
                        destination: destination
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'è·¯çº¿è§„åˆ’å¤±è´¥');
                }
                
                // ä¿å­˜è·¯çº¿æ•°æ®
                routeData = data;
                
                // åœ¨åœ°å›¾ä¸Šç»˜åˆ¶è·¯çº¿
                await drawRouteOnMap(data);
                
                // æ˜¾ç¤ºè·¯çº¿ä¿¡æ¯
                displayRouteInfo(data);
                
                showSuccess('è·¯çº¿è§„åˆ’æˆåŠŸï¼');
                
            } catch (error) {
                console.error('è·¯çº¿è§„åˆ’å¤±è´¥:', error);
                
                if (error.name === 'AbortError') {
                    showError('è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨ã€‚å¯åŠ¨å‘½ä»¤ï¼šmvn spring-boot:run');
                } else if (error.message.includes('HTTPé”™è¯¯')) {
                    showError('åç«¯æœåŠ¡æœªå“åº”ï¼Œè¯·ç¡®ä¿Spring Bootåº”ç”¨å·²å¯åŠ¨');
                } else {
                    showError('è·¯çº¿è§„åˆ’å¤±è´¥ï¼š' + error.message);
                }
            } finally {
                showLoading(false);
            }
        }
        
        // åœ¨åœ°å›¾ä¸Šç»˜åˆ¶è·¯çº¿
        async function drawRouteOnMap(data) {
            if (!map) return;
            
            // æ¸…é™¤ä¹‹å‰çš„è·¯çº¿å’Œæ ‡è®°
            map.clearMap();
            
            // è§£æåæ ‡
            const originCoords = parseCoordinate(data.originCoordinate);
            const destCoords = parseCoordinate(data.destinationCoordinate);
            
            // æ·»åŠ èµ·ç‚¹å’Œç»ˆç‚¹æ ‡è®°
            const originMarker = new AMap.Marker({
                position: originCoords,
                map: map,
                icon: 'https://webapi.amap.com/theme/v1.3/markers/n/start.png',
                title: 'èµ·ç‚¹'
            });
            
            const destMarker = new AMap.Marker({
                position: destCoords,
                map: map,
                icon: 'https://webapi.amap.com/theme/v1.3/markers/n/end.png',
                title: 'ç»ˆç‚¹'
            });
            
            // ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„è·¯çº¿æ•°æ®è¿›è¡Œç»˜åˆ¶
            drawCustomRoute(data.routeData);
            
            // è°ƒæ•´åœ°å›¾è§†é‡
            map.setFitView();
        }
        
        // ç»˜åˆ¶è‡ªå®šä¹‰è·¯çº¿ï¼ˆä½¿ç”¨åç«¯è¿”å›çš„è·¯çº¿æ•°æ®ï¼‰
        function drawCustomRoute(routeData) {
            if (!routeData || !routeData.paths || !routeData.paths[0]) return;
            
            const path = routeData.paths[0];
            
            // ç»˜åˆ¶è·¯çº¿è·¯å¾„
            if (path.steps && path.steps.length > 0) {
                const polyline = new AMap.Polyline({
                    path: path.steps.flatMap(step => {
                        return step.polyline.split(';').map(point => {
                            const [lng, lat] = point.split(',');
                            return [parseFloat(lng), parseFloat(lat)];
                        });
                    }),
                    strokeColor: '#3366FF',
                    strokeWeight: 6,
                    strokeOpacity: 0.8,
                    map: map
                });
            }
        }
        
        // æ˜¾ç¤ºè·¯çº¿ä¿¡æ¯
        function displayRouteInfo(data) {
            const routeInfo = document.getElementById('routeInfo');
            
            if (!data.routeData || !data.routeData.paths || !data.routeData.paths[0]) {
                routeInfo.innerHTML = '<div class="info-section"><h3>ğŸ“Š è·¯çº¿ä¿¡æ¯</h3><p>æš‚æ— è·¯çº¿æ•°æ®</p></div>';
                return;
            }
            
            const route = data.routeData.paths[0];
            
            let html = `
                <div class="info-section">
                    <h3>ğŸ“Š è·¯çº¿ä¿¡æ¯</h3>
                    <div class="info-item">
                        <span class="info-label">æ€»è·ç¦»ï¼š</span>
                        <span class="info-value">${(route.distance / 1000).toFixed(2)} å…¬é‡Œ</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">é¢„è®¡æ—¶é—´ï¼š</span>
                        <span class="info-value">${Math.round(route.duration / 60)} åˆ†é’Ÿ</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">èµ·ç‚¹åæ ‡ï¼š</span>
                        <span class="info-value">${data.originCoordinate}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ç»ˆç‚¹åæ ‡ï¼š</span>
                        <span class="info-value">${data.destinationCoordinate}</span>
                    </div>
                </div>
            `;
            
            // æ˜¾ç¤ºè·¯å¾„æ­¥éª¤
            if (route.steps && route.steps.length > 0) {
                html += `
                    <div class="info-section">
                        <h3>ğŸš¶ æ­¥è¡ŒæŒ‡å¼•</h3>
                        <div class="path-steps">
                            ${route.steps.map((step, index) => `
                                <div class="path-step">
                                    <strong>æ­¥éª¤ ${index + 1}:</strong> ${step.instruction || 'ç»§ç»­å‰è¿›'}
                                    ${step.distance ? ` (${step.distance}ç±³)` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            routeInfo.innerHTML = html;
        }
        
        // æ¸…é™¤è·¯çº¿
        function clearRoute() {
            if (map) {
                map.clearMap();
            }
            
            document.getElementById('origin').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('routeInfo').innerHTML = `
                <div class="info-section">
                    <h3>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
                    <p>è¾“å…¥èµ·ç‚¹å’Œç»ˆç‚¹åœ°å€æˆ–ç»çº¬åº¦åæ ‡ï¼Œç‚¹å‡»"è§„åˆ’è·¯çº¿"æŒ‰é’®å³å¯ç”Ÿæˆæ­¥è¡Œè·¯çº¿ã€‚</p>
                    <p>æ”¯æŒæ ¼å¼ï¼š</p>
                    <ul>
                        <li>åœ°å€ï¼š"åŒ—äº¬å¸‚æµ·æ·€åŒºä¸­å…³æ‘å¤§è¡—"</li>
                        <li>åæ ‡ï¼š"116.397428,39.90923"</li>
                    </ul>
                </div>
            `;
            
            routeData = null;
            showSuccess('è·¯çº¿å·²æ¸…é™¤');
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šè§£æåæ ‡å­—ç¬¦ä¸²
        function parseCoordinate(coordinateStr) {
            if (!coordinateStr || typeof coordinateStr !== 'string') {
                console.warn('æ— æ•ˆçš„åæ ‡å­—ç¬¦ä¸²:', coordinateStr);
                return [116.397428, 39.90923]; // è¿”å›é»˜è®¤åæ ‡ï¼ˆåŒ—äº¬ï¼‰
            }
            
            const [lngStr, latStr] = coordinateStr.split(',').map(coord => coord.trim());
            const lng = parseFloat(lngStr);
            const lat = parseFloat(latStr);
            
            // éªŒè¯åæ ‡æœ‰æ•ˆæ€§
            if (isNaN(lng) || isNaN(lat) || lng < -180 || lng > 180 || lat < -90 || lat > 90) {
                console.warn('æ— æ•ˆçš„åæ ‡å€¼:', coordinateStr, 'lng:', lng, 'lat:', lat);
                return [116.397428, 39.90923]; // è¿”å›é»˜è®¤åæ ‡ï¼ˆåŒ—äº¬ï¼‰
            }
            
            return [lng, lat];
        }
        
        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            const loading = document.getElementById('loading');
            loading.style.display = show ? 'block' : 'none';
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            
            setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 5000);
        }
        
        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        function showSuccess(message) {
            const successMsg = document.getElementById('successMessage');
            successMsg.textContent = message;
            successMsg.style.display = 'block';
            
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®é»˜è®¤å€¼ï¼ˆå¯é€‰ï¼‰
            document.getElementById('origin').value = 'åŒ—äº¬å¸‚æµ·æ·€åŒºä¸­å…³æ‘å¤§è¡—';
            document.getElementById('destination').value = 'åŒ—äº¬å¸‚æœé˜³åŒºä¸‰é‡Œå±¯';
            
            // åˆå§‹åŒ–åœ°å›¾
            initMap();
        });
    </script>
</body>
</html>